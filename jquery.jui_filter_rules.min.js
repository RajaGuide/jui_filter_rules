/**
 * @fileOverview jui_filter_rules - Create rules to filter dataset using jquery
 *               <p>License MIT
 *               <br />Copyright 2012 Christos Pontikis <a href="http://pontikis.net">http://pontikis.net</a>
 *               <br />Project page <a href="https://github.com/pontikis/jui_filter_rules">https://github.com/pontikis/jui_filter_rules</a>
 * @version 1.00
 * @author Christos Pontikis http://pontikis.net
 * @requires jquery, jquery-ui
 */
"use strict";(function(e){var a="jui_filter_rules",h="jui_filter_rules_status",g=["text","number","date"],r=[{type:"equal",accept_values:"yes",apply_to:["text","number","date"],group:"equality"},{type:"not_equal",accept_values:"yes",apply_to:["text","number","date"],group:"equality"},{type:"in",accept_values:"yes",apply_to:["text","number","date"],group:"multiple_choice"},{type:"not_in",accept_values:"yes",apply_to:["text","number","date"],group:"multiple_choice"},{type:"less",accept_values:"yes",apply_to:["number","date"],group:"inequality"},{type:"less_or_equal",accept_values:"yes",apply_to:["number","date"],group:"inequality"},{type:"greater",accept_values:"yes",apply_to:["number","date"],group:"inequality"},{type:"greater_or_equal",accept_values:"yes",apply_to:["number","date"],group:"inequality"},{type:"begins_with",accept_values:"yes",apply_to:["text"],group:"substring"},{type:"not_begins_with",accept_values:"yes",apply_to:["text"],group:"substring"},{type:"contains",accept_values:"yes",apply_to:["text"],group:"substring"},{type:"not_contains",accept_values:"yes",apply_to:["text"],group:"substring"},{type:"ends_with",accept_values:"yes",apply_to:["text"],group:"substring"},{type:"not_ends_with",accept_values:"yes",apply_to:["text"],group:"substring"},{type:"is_empty",accept_values:"no",apply_to:["text"],group:"empty_string"},{type:"is_not_empty",accept_values:"no",apply_to:["text"],group:"empty_string"},{type:"is_null",accept_values:"no",apply_to:["text","number","date"],group:"null"},{type:"is_not_null",accept_values:"no",apply_to:["text","number","date"],group:"null"}];var u={init:function(z){var A=this;return this.each(function(){var U=A.data(a);if(typeof(U)=="undefined"){var J=A.jui_filter_rules("getDefaults");U=e.extend({},J,z)}else{U=e.extend({},U,z)}A.data(a,U);if(typeof A.data(h)==="undefined"){A.data(h,{});A.data(h)["rule_id"]=0}var R=A.attr("id");d(R);A.unbind("onValidationError").bind("onValidationError",U.onValidationError);var H=U.filters,O=n(U.filters_list_id_prefix,R)+"_",Q=n(U.operators_container_id_prefix,R)+"_",I=n(U.operators_list_id_prefix,R)+"_",K=n(U.filter_value_id_prefix,R)+"_",T=n(U.group_tools_id_prefix,R)+"_",M=n(U.rule_tools_id_prefix,R)+"_",E,G,V,D,N,Y,X,C,P,S,F,B,L,W;if(A.data(h)["rule_id"]==0){if(H.length>0){A.html(o(R))}}A.addClass(U.containerClass);P='[id^="'+T+'"]';A.off("change",P).on("change",P,function(){S=T.length;F=e(this).attr("id").substr(S);L=e(this).val();switch(L){case"rule_insert_before":e(this).closest("dt").parent("dl").before(m(R));break;case"rule_insert_after":e(this).closest("dt").parent("dl").after(m(R));break;case"rule_insert_inside":e(this).closest("dt").next("dd:first").find("ul:first").prepend(m(R));break;case"group_insert_before":e(this).closest("dl").before(o(R));break;case"group_insert_after":e(this).closest("dl").after(o(R));break;case"group_insert_inside":e(this).closest("dt").next("dd:first").find("ul:first").prepend(o(R));break;case"group_delete":e(this).closest("dl").remove();break}e(this).prop("selectedIndex",0)});P='[id^="'+M+'"]';A.off("change",P).on("change",P,function(){S=M.length;F=e(this).attr("id").substr(S);W=e(this).val();switch(W){case"rule_insert_before":e(this).closest("li").before(m(R));break;case"rule_insert_after":e(this).closest("li").after(m(R));break;case"rule_clear":E=O+F;V=Q+F;D=K+F;N=e("#"+E);X=e("#"+V);C=e("#"+D);N.prop("selectedIndex",0);X.html("");C.html("");break;case"rule_delete":e(this).closest("li").remove();break;case"group_insert_before":e(this).closest("li").before(o(R));break;case"group_insert_after":e(this).closest("li").after(o(R));break}e(this).prop("selectedIndex",0)});P='[id^="'+O+'"]';A.off("change",P).on("change",P,function(){S=O.length;F=e(this).attr("id").substr(S);B=e(this).prop("selectedIndex")-1;V=Q+F;G=I+F;D=K+F;X=e("#"+V);C=e("#"+D);if(B>=0){X.html(s(R,F,e(this).val()));Y=e("#"+G);j(R,F,e(this).val(),Y.val())}else{X.html("");C.html("")}});P='[id^="'+I+'"]';A.off("change",P).on("change",P,function(){S=I.length;F=e(this).attr("id").substr(S);E=O+F;G=I+F;D=K+F;N=e("#"+E);Y=e("#"+G);C=e("#"+D);B=N.prop("selectedIndex")-1;if(B>=0){j(R,F,N.val(),Y.val())}else{C.html("")}})})},getDefaults:function(){return{filters:[],filter_widget_locale:"",decimal_separator:".",htmlentities:false,containerClass:"filter_rules_container",rulesGroupContainerClass:"rules_group_container",rulesGroupHeaderClass:"rules_group_header",rulesGroupBodyClass:"rules_group_body",rulesGroupConditionContainerClass:"rules_group_condition_container",rulesGroupConditionListClass:"rules_group_condition_list",rulesGroupToolsContainerClass:"rules_group_tools_container",rulesGroupToolsListClass:"rules_group_tools_list",rulesListClass:"rules_list",rulesListLiClass:"rules_list_li",rulesListLiErrorClass:"rules_list_error_li",filterContainerClass:"filter_container",filterListClass:"filter_list",operatorsListContainerClass:"operators_list_container",operatorsListClass:"operators_list",filterValueContainerClass:"filter_value_container",filterInputTextClass:"filter_input_text",filterInputNumberClass:"filter_input_number",filterInputDateClass:"filter_input_date",filterInputCheckboxClass:"filter_input_checkbox",filterInputRadioClass:"filter_input_radio",filterSelectClass:"filter_select",filterGroupListClass:"filter_group_list",filterGroupListItemHorizontalClass:"filter_group_list_item_horizontal",filterGroupListItemVerticalClass:"filter_group_list_item_vertical",ruleToolsContainerClass:"rule_tools_container",ruleToolsClass:"rule_tools_list",group_tools_id_prefix:"group_tools_",rule_li_id_prefix:"rule_",filters_list_id_prefix:"filters_list_",operators_container_id_prefix:"oper_wrap_",operators_list_id_prefix:"oper_list_",filter_value_id_prefix:"filter_value_",filter_element_id_prefix:"flt_",filter_element_name_prefix:"flt_name_",rule_tools_id_prefix:"rule_tools_",onValidationError:function(){}}},getOption:function(z){var A=this;return A.data(a)[z]},getAllOptions:function(){var z=this;return z.data(a)},setOption:function(z,C,B){var A=this;A.data(a)[z]=C;if(B){A.jui_filter_rules("init")}},destroy:function(){return e(this).each(function(){var z=e(this);z.removeData(a)})},getRules:function(R,N){var Q=this,O=Q.attr("id"),A,K,B,z,M,J,H,L,G,P,C,D=n(Q.jui_filter_rules("getOption","rule_li_id_prefix"),O)+"_",I=D.length,F,E;A=Q.find("dl").eq(R);K=A.find("dt:first").find("select:first").val();B=A.find("dd:first").find("ul:first").children().get();z=B.length;for(M=0;M<z;M++){J=B[M];H={};if(J.tagName=="LI"){if(e(J).find("select:first").prop("selectedIndex")==0){continue}F=e(J).attr("id").substr(I);H.condition={};L=e(J).find("select:first").val();P=l(O,L);G=e(J).find("select").eq(1).val();H.condition.filterType=P.filterType;H.condition.field=P.field;H.condition.operator=G;C=y(O,F,P,G);if(C===false){return false}else{H.condition.filterValue=C}H.logical_operator=K;N.push(H)}else{if(J.tagName=="DL"){H.condition=[];H.logical_operator=K;N.push(H);E=N.length-1;R=parseInt(R)+1;Q.jui_filter_rules("getRules",R,N[E].condition);t(N)}}}return N}};var d=function(E){var D=e("#"+E),F,z,C=D.jui_filter_rules("getOption","filters"),B=C.length,A=[];for(z=0;z<B;z++){A.push(C[z].filterName)}if(k(A)){F="Filternames are not unique...";D.html('<span style="color: red;">ERROR: '+F+"</span>");e.error(F)}};var n=function(A,z){return A+z};var k=function(B){var A={},z=B.length,C;for(C=0;C<z;C++){if(A[B[C]]===true){return true}A[B[C]]=true}return false};var b=function(z){if(z){return jQuery("<div />").text(z).html()}else{return""}};var f=function(z){if(z){return e("<div />").html(z).text()}else{return""}};var v=function(A){var z={},B;for(B in A){if(A.hasOwnProperty(B)){if(A[B]!==""){z[B]=A[B]}}}return z};var t=function(A){var B,C,z=A.length;for(B=0;B<z;B++){C=A[B].condition;if(e.isArray(C)){if(C.length==0){A.splice(B,1)}else{t(C)}}}};var l=function(D,E){var C=e("#"+D),z,B=C.jui_filter_rules("getOption","filters"),A=B.length,F=undefined;for(z=0;z<A;z++){if(B[z].filterName==E){F=B[z];break}}return F};var x=function(D,F){var B=e("#"+D),A=B.jui_filter_rules("getOption","filters"),z,G,I,H=r.length,E,C=[],J;z=l(D,F);G=z.filterType;I=(z.excluded_operators===undefined?[]:z.excluded_operators);for(E=0;E<H;E++){if(e.inArray(r[E].type,I)>-1){continue}if(e.inArray(G,r[E].apply_to)>-1){J={};J.operator_type=r[E].type;J.operator_label=rsc_jui_fr["operator_"+r[E].type];J.group=r[E].group;C.push(J)}}return C};var i=function(B){var A,z=r.length,C=undefined;for(A=0;A<z;A++){if(r[A].type==B){C=r[A];break}}return C};var w=function(C){var A=e("#"+C),D=A.jui_filter_rules("getOption","rulesGroupConditionContainerClass"),z=A.jui_filter_rules("getOption","rulesGroupConditionListClass"),B="";B+='<div class="'+D+'">';B+='<select class="'+z+'">';B+='<option value="AND">'+rsc_jui_fr.rules_group_AND+":</option>";B+='<option value="OR">'+rsc_jui_fr.rules_group_OR+":</option>";B+="</select>";B+="</div>";return B};var q=function(A){var z=e("#"+A),E=parseInt(z.data(h)["rule_id"]),D=z.jui_filter_rules("getOption","rulesGroupToolsContainerClass"),H=z.jui_filter_rules("getOption","rulesGroupToolsListClass"),B=n(z.jui_filter_rules("getOption","group_tools_id_prefix"),A)+"_"+E,C=(E==0?' disabled="disabled"':""),F=(e.browser.msie&&parseInt(e.browser.version)<9?"":" tools_list_shrink"),G="";G+='<div class="'+D+'">';G+='<select id="'+B+'" class="'+H+F+'">';G+='<option value="please_select">'+rsc_jui_fr.tools_please_select+"</option>";G+='<optgroup label="'+rsc_jui_fr.rule+'">';G+='<option value="rule_insert_before"'+C+">"+rsc_jui_fr.rule_insert_before+"</option>";G+='<option value="rule_insert_after"'+C+">"+rsc_jui_fr.rule_insert_after+"</option>";G+='<option value="rule_insert_inside">'+rsc_jui_fr.rule_insert_inside+"</option>";G+="</optgroup>";G+='<optgroup label="'+rsc_jui_fr.group+'">';G+='<option value="group_insert_before"'+C+">"+rsc_jui_fr.group_insert_before+"</option>";G+='<option value="group_insert_after"'+C+">"+rsc_jui_fr.group_insert_after+"</option>";G+='<option value="group_insert_inside">'+rsc_jui_fr.group_insert_inside+"</option>";G+='<option value="group_delete"'+C+">"+rsc_jui_fr.group_delete+"</option>";G+="</optgroup>";G+="</select>";G+="</div>";return G};var p=function(D){var C=e("#"+D),H=parseInt(C.data(h)["rule_id"]),B=C.jui_filter_rules("getOption","filters"),I=B.length,G=C.jui_filter_rules("getOption","filterContainerClass"),A=C.jui_filter_rules("getOption","filterListClass"),z=n(C.jui_filter_rules("getOption","filters_list_id_prefix"),D)+"_"+H,E,F="";F+='<div class="'+G+'">';F+='<select id="'+z+'" class="'+A+'">';F+='<option value="no_filter">'+rsc_jui_fr.filter_please_select+"</option>";for(E=0;E<I;E++){F+='<option value="'+B[E].filterName+'">'+B[E].filterLabel+"</option>"}F+="</select>";F+="</div>";return F};var s=function(D,J,G){var A=e("#"+D),M=n(A.jui_filter_rules("getOption","operators_container_id_prefix"),D)+"_"+J,H=e("#"+M),C=A.jui_filter_rules("getOption","operatorsListClass"),E=n(A.jui_filter_rules("getOption","operators_list_id_prefix"),D)+"_",L=E+J,B,F,I,K="",z="";B=x(D,G);I=B.length;K+='<select id="'+L+'" class="'+C+'">';for(F=0;F<I;F++){if(B[F].group!==z){K+='<optgroup label="&raquo;">';z=B[F].group}K+='<option value="'+B[F].operator_type+'">'+B[F].operator_label+"</option>";if(F<I-1&&B[parseInt(F)+1].group!==z){K+="</optgroup>"}}K+="</select>";H.html(K)};var j=function(R,I,ab,P){var aj=e("#"+R),ak=i(P),ad=n(aj.jui_filter_rules("getOption","filter_value_id_prefix"),R)+"_"+I,ap=e("#"+ad),O=aj.jui_filter_rules("getOption","filters"),X=v(l(R,ab)),S=X.filterType,A=X.filter_interface,F=A.length,am,C,D,L,J="",M,Y,B=["id","name"],Q="",al,ae,U,ah,V="",z="no",ai,H=aj.jui_filter_rules("getOption","filterGroupListClass"),ag=aj.jui_filter_rules("getOption","filterGroupListItemHorizontalClass"),ac=aj.jui_filter_rules("getOption","filterGroupListItemVerticalClass"),an=aj.jui_filter_rules("getOption","filter_widget_locale"),G="";if(ak.accept_values!=="yes"){ap.html("");return true}if(X.hasOwnProperty("lookup_values_ajax_url")){V=X.lookup_values_ajax_url;e.ajax({url:V,success:(function(aq){al=e.parseJSON(aq);ap.html(T());K()})})}else{if(X.hasOwnProperty("lookup_values")){al=X.lookup_values}ap.html(T());K()}function T(){for(am=0;am<F;am++){C=A[am].filter_element;M=v(A[am].filter_element_attributes);if(C=="input"){J=M.type}N();if(J=="checkbox"||J=="radio"){ao();ae=al.length;G+='<ul class="'+H+'">';for(U=0;U<ae;U++){G+='<li class="'+ai+'">';G+="<"+C;aa(U);G+=' id="'+D+'"';if(J=="radio"){af();G+=' name="'+L+'"'}W();G+=' value="'+al[U]["lk_value"]+'"';ah=(al[U]["lk_selected"]=="yes"?' checked="checked"':"");G+=ah;G+=">";G+='<label for="'+D+'">'+al[U]["lk_option"]+"</label>";G+="</li>"}G+="</ul>"}else{G+="<"+C;aa(am);G+=' id="'+D+'"';W();G+=">";if(C=="select"){E()}if(C=="div"){G+="</div>"}}}return G}function aa(aq){D=n(aj.jui_filter_rules("getOption","filter_element_id_prefix"),R)+"_"+I+"_"+aq}function af(){L=n(aj.jui_filter_rules("getOption","filter_element_name_prefix"),R)+"_"+I}function N(){if(C=="input"){if(J=="text"){B=["id","name"]}else{if(J=="radio"){B=["id","name","value","checked"]}else{if(J=="checkbox"){B=["id","name","value","checked"]}}}}else{if(C=="select"){B=["id","name","value"]}}}function Z(){var aq="";Q="";if(C=="input"){if(J=="text"){if(S=="text"){aq="filterInputTextClass"}else{if(S=="number"){aq="filterInputNumberClass"}else{if(S=="date"){aq="filterInputDateClass"}}}}else{if(J=="radio"){aq="filterInputRadioClass"}else{if(J=="checkbox"){aq="filterInputCheckboxClass"}}}}else{if(C=="select"){aq="filterSelectClass"}}if(aq!==""){Q=aj.jui_filter_rules("getOption",aq)}}function W(){for(Y in M){if(M.hasOwnProperty(Y)){if(e.inArray(Y,B)>-1){continue}G+=" "+Y+'="'+M[Y]+'"'}}if(!M.hasOwnProperty("class")){Z();if(Q!==""){G+=' class="'+Q+'"'}}}function E(){ae=al.length;for(U=0;U<ae;U++){ah=(al[U]["lk_selected"]=="yes"?' selected="selected"':"");G+='<option value="'+al[U]["lk_value"]+'"'+ah+">"+al[U]["lk_option"]+"</option>"}G+="</select>"}function ao(){z="no";if(A[am].hasOwnProperty("vertical_orientation")){z=A[am].vertical_orientation}ai=(z=="yes"?ac:ag)}function K(){if(J=="checkbox"||J=="radio"){return true}for(am=0;am<F;am++){if(!A[am].hasOwnProperty("filter_widget")){continue}D=n(aj.jui_filter_rules("getOption","filter_element_id_prefix"),R)+"_"+I+"_"+am;var ar=e("#"+D);var at=A[am]["filter_widget"];var aq=A[am]["filter_widget_properties"];if(at=="datepicker"){ar.datepicker(aq,e.datepicker.regional[an])}if(at=="datetimepicker"){ar.datetimepicker(aq,e.datepicker.regional[an],e.timepicker.regional[an])}if(at=="autocomplete"){ar.autocomplete(aq)}if(at=="spinner"){ar.spinner(aq)}if(at=="slider"){ar.slider(aq)}}return true}return true};var c=function(D){var B=e("#"+D),A=parseInt(B.data(h)["rule_id"]),G=B.jui_filter_rules("getOption","ruleToolsContainerClass"),F=B.jui_filter_rules("getOption","ruleToolsClass"),z=n(B.jui_filter_rules("getOption","rule_tools_id_prefix"),D)+"_"+A,E=(e.browser.msie&&parseInt(e.browser.version)<9?"":" tools_list_shrink"),C="";C+='<div class="'+G+'">';C+='<select id="'+z+'" class="'+F+E+'">';C+='<option value="please_select">'+rsc_jui_fr.tools_please_select+"</option>";C+='<optgroup label="'+rsc_jui_fr.rule+'">';C+='<option value="rule_insert_before">'+rsc_jui_fr.rule_insert_before+"</option>";C+='<option value="rule_insert_after">'+rsc_jui_fr.rule_insert_after+"</option>";C+='<option value="rule_clear">'+rsc_jui_fr.rule_clear+"</option>";C+='<option value="rule_delete">'+rsc_jui_fr.rule_delete+"</option>";C+="</optgroup>";C+='<optgroup label="'+rsc_jui_fr.group+'">';C+='<option value="group_insert_before">'+rsc_jui_fr.group_insert_before+"</option>";C+='<option value="group_insert_after">'+rsc_jui_fr.group_insert_after+"</option>";C+="</optgroup>";C+="</select>";C+="</div>";return C};var o=function(F){var D=e("#"+F),E=D.jui_filter_rules("getOption","rulesGroupContainerClass"),C=D.jui_filter_rules("getOption","rulesGroupHeaderClass"),B=D.jui_filter_rules("getOption","rulesGroupBodyClass"),z=D.jui_filter_rules("getOption","rulesListClass"),A="";A+='<dl class="'+E+'">';A+='<dt class="'+C+'">';A+=w(F);A+=q(F);A+="</dt>";A+='<dd class="'+B+'">';A+='<ul class="'+z+'">';A+=m(F);A+="</ul>";A+="</dd>";A+="</dl>";return A};var m=function(C){var B=e("#"+C),F=B.jui_filter_rules("getOption","rulesListLiClass"),E=B.jui_filter_rules("getOption","operatorsListContainerClass"),D=B.jui_filter_rules("getOption","filterValueContainerClass"),J=n(B.jui_filter_rules("getOption","rule_li_id_prefix"),C)+"_",I=n(B.jui_filter_rules("getOption","operators_container_id_prefix"),C)+"_",A=n(B.jui_filter_rules("getOption","filter_value_id_prefix"),C)+"_",H,L,K,z="";var G=parseInt(B.data(h)["rule_id"])+1;B.data(h)["rule_id"]=G;L=I+G;K=A+G;H=J+G;z+='<li id="'+H+'" class="'+F+'">';z+=p(C);z+='<div id="'+L+'" class="'+E+'">';z+="</div>";z+='<div id="'+K+'" class="'+D+'">';z+="</div>";z+=c(C);z+="</li>";return z};var y=function(X,H,K,C){var Z=e("#"+X),U=K.filterType,T=K.filter_interface,G=T.length,W,V,O=Z.jui_filter_rules("getOption","filter_element_id_prefix"),R,Q="",D,P,I=i(C),B=n(Z.jui_filter_rules("getOption","rule_li_id_prefix"),X)+"_"+H,Y=e("#"+B),A=Z.jui_filter_rules("getOption","rulesListLiErrorClass"),F=Z.jui_filter_rules("getOption","decimal_separator"),S=new RegExp(F,"g"),E=Z.jui_filter_rules("getOption","htmlentities"),M,N=[],z,L;if(I.accept_values!=="yes"){return N}Y.removeClass(A);for(W=0;W<G;W++){if(T[W].hasOwnProperty("returns_no_value")){if(T[W]["returns_no_value"]=="yes"){continue}}V=T[W].filter_element;D=T[W].filter_element_attributes;if(V=="input"){Q=D.type;if(Q=="text"){R=J(W);M=e("#"+R);N.push(M.val())}if(Q=="checkbox"||Q=="radio"){P=e('[id^="'+n(O,X)+"_"+H+'_"]');P.each(function(){if(e(this).is(":checked")){N.push(e(this).val())}})}}if(V=="select"){R=J(W);M=e("#"+R);if(D.hasOwnProperty("multiple")){N=M.val()}else{N.push(M.val())}}}if(U=="number"){z=N.length;for(L=0;L<z;L++){N[L]=N[L].replace(S,".");if(!e.isNumeric(N[L])){Y.addClass(A);Z.triggerHandler("onValidationError",{err_num:1,err_description:"Value is not numeric"});return false}}}if(U!=="number"){if(E){z=N.length;for(L=0;L<z;L++){N[L]=b(N[L])}}}function J(aa){return n(O,X)+"_"+H+"_"+aa}return N};e.fn.jui_filter_rules=function(A){if(this.size()!=1){var z="You must use this plugin ("+a+") with a unique element (at once)";this.html('<span style="color: red;">ERROR: '+z+"</span>");e.error(z)}if(u[A]){return u[A].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof A==="object"||!A){return u.init.apply(this,arguments)}else{e.error("Method "+A+" does not exist on jQuery."+a)}}}})(jQuery);
